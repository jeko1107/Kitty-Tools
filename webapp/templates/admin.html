{% extends 'base.html' %}
{% block content %}
  <h1>Panel de Administraci√≥n</h1>
  
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="card" style="margin-bottom:1rem">
        {% for cat, msg in messages %}
          <div style="padding:0.5rem;margin:0.25rem 0;background:{{ '#1a2f1a' if cat=='success' else '#2f1a1a' }};border-left:3px solid {{ '#86efac' if cat=='success' else '#fca5a5' }};color:{{ '#86efac' if cat=='success' else '#fca5a5' }}">
            {{ msg }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="card" style="background:#0f1a24;border:1px solid #1e3a5f">
    <h2 style="color:#60a5fa;margin-top:0">üöÄ Ejecutar Script</h2>
    <p style="color:#94a3b8">Configura y ejecuta las herramientas de Kahoot. Los resultados se mostrar√°n en tiempo real.</p>
    
    <form method="post" action="{{ url_for('admin_simulate') }}" style="margin-top:1rem">
      <input type="hidden" name="_csrf" value="{{ csrf_token }}">
      
      <div style="margin-bottom:1rem">
        <label style="color:#e2e8f0;font-weight:bold;display:block;margin-bottom:0.5rem">Tipo de Herramienta</label>
        <select name="sim_type" id="sim_type" style="width:100%;padding:0.5rem;background:#1e293b;color:#e2e8f0;border:1px solid #334155;border-radius:4px;font-size:1rem" onchange="updateParamsPlaceholder()">
          <option value="flood">üåä Kahoot Flood - Enviar m√∫ltiples bots</option>
          <option value="answers">üìù Answer Hack - Obtener respuestas</option>
          <option value="graphical">üñ•Ô∏è GUI - Interfaz gr√°fica</option>
        </select>
      </div>

      <!-- Par√°metros separados en casillas individuales -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1rem" id="params_grid">
        
        <!-- N√∫mero de bots / elementos -->
        <div>
          <label style="color:#e2e8f0;font-weight:bold;display:block;margin-bottom:0.5rem">
            <span id="label_n">ü§ñ N√∫mero de Bots</span>
          </label>
          <input type="number" name="param_n" id="param_n" placeholder="50" min="1" max="1000" 
                 style="width:100%;padding:0.5rem;background:#1e293b;color:#e2e8f0;border:1px solid #334155;border-radius:4px;font-size:1rem">
          <small style="color:#64748b;display:block;margin-top:0.25rem">Cantidad de elementos a simular</small>
        </div>

        <!-- PIN del juego -->
        <div id="pin_field">
          <label style="color:#e2e8f0;font-weight:bold;display:block;margin-bottom:0.5rem">
            üéØ PIN del Juego
          </label>
          <input type="text" name="param_pin" id="param_pin" placeholder="1234567" 
                 style="width:100%;padding:0.5rem;background:#1e293b;color:#e2e8f0;border:1px solid #334155;border-radius:4px;font-size:1rem">
          <small style="color:#64748b;display:block;margin-top:0.25rem">PIN del Kahoot (opcional)</small>
        </div>

        <!-- Latencia m√≠nima -->
        <div id="minlat_field">
          <label style="color:#e2e8f0;font-weight:bold;display:block;margin-bottom:0.5rem">
            ‚è±Ô∏è Latencia M√≠nima
          </label>
          <input type="number" name="param_minlat" id="param_minlat" placeholder="50" min="0" max="5000" 
                 style="width:100%;padding:0.5rem;background:#1e293b;color:#e2e8f0;border:1px solid #334155;border-radius:4px;font-size:1rem">
          <small style="color:#64748b;display:block;margin-top:0.25rem">En milisegundos (ms)</small>
        </div>

        <!-- Latencia m√°xima -->
        <div id="maxlat_field">
          <label style="color:#e2e8f0;font-weight:bold;display:block;margin-bottom:0.5rem">
            ‚è±Ô∏è Latencia M√°xima
          </label>
          <input type="number" name="param_maxlat" id="param_maxlat" placeholder="300" min="0" max="5000" 
                 style="width:100%;padding:0.5rem;background:#1e293b;color:#e2e8f0;border:1px solid #334155;border-radius:4px;font-size:1rem">
          <small style="color:#64748b;display:block;margin-top:0.25rem">En milisegundos (ms)</small>
        </div>

        <!-- N√∫mero de preguntas (solo para answers) -->
        <div id="q_field" style="display:none">
          <label style="color:#e2e8f0;font-weight:bold;display:block;margin-bottom:0.5rem">
            ‚ùì N√∫mero de Preguntas
          </label>
          <input type="number" name="param_q" id="param_q" placeholder="10" min="1" max="100" 
                 style="width:100%;padding:0.5rem;background:#1e293b;color:#e2e8f0;border:1px solid #334155;border-radius:4px;font-size:1rem">
          <small style="color:#64748b;display:block;margin-top:0.25rem">Cantidad de preguntas del quiz</small>
        </div>

        <!-- Precisi√≥n (solo para answers) -->
        <div id="acc_field" style="display:none">
          <label style="color:#e2e8f0;font-weight:bold;display:block;margin-bottom:0.5rem">
            üéØ Precisi√≥n
          </label>
          <input type="number" name="param_acc" id="param_acc" placeholder="0.8" min="0" max="1" step="0.1" 
                 style="width:100%;padding:0.5rem;background:#1e293b;color:#e2e8f0;border:1px solid #334155;border-radius:4px;font-size:1rem">
          <small style="color:#64748b;display:block;margin-top:0.25rem">De 0.0 (0%) a 1.0 (100%)</small>
        </div>

      </div>

      <button class="btn" type="submit" style="background:#2563eb;color:white;padding:0.75rem 1.5rem;font-size:1rem;font-weight:bold;cursor:pointer;border:none;border-radius:4px">
        ‚ñ∂Ô∏è Ejecutar
      </button>
    </form>
  </div>

  <div class="card" style="background:#0f1a24;border:1px solid #1e3a5f;margin-top:1.5rem">
    <h2 style="color:#60a5fa;margin-top:0">üìä Historial de Ejecuciones</h2>
    {% if jobs %}
      <div style="overflow-x:auto">
        <table style="width:100%;border-collapse:collapse;color:#e2e8f0">
          <thead>
            <tr style="background:#1e293b;border-bottom:2px solid #334155">
              <th style="padding:0.75rem;text-align:left">ID</th>
              <th style="padding:0.75rem;text-align:left">Tipo</th>
              <th style="padding:0.75rem;text-align:left">Estado</th>
              <th style="padding:0.75rem;text-align:left">Usuario</th>
              <th style="padding:0.75rem;text-align:left">Fecha</th>
              <th style="padding:0.75rem;text-align:left">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for job in jobs %}
              <tr style="border-bottom:1px solid #334155;{{ 'background:#1a2f1a' if job.status == 'simulated' else '' }}">
                <td style="padding:0.75rem;font-family:monospace;font-size:0.85rem">{{ job.id[:12] }}...</td>
                <td style="padding:0.75rem">
                  {% if job.type == 'flood' %}üåä Flood
                  {% elif job.type == 'answers' %}üìù Answers
                  {% elif job.type == 'graphical' %}üñ•Ô∏è GUI
                  {% else %}{{ job.type }}{% endif %}
                </td>
                <td style="padding:0.75rem">
                  <span style="padding:0.25rem 0.5rem;border-radius:3px;background:{{ '#1a2f1a' if job.status == 'simulated' else '#2f2a1a' }};color:{{ '#86efac' if job.status == 'simulated' else '#fcd34d' }}">
                    {{ job.status }}
                  </span>
                </td>
                <td style="padding:0.75rem">{{ job.user }}</td>
                <td style="padding:0.75rem;font-size:0.85rem">{{ job.created_at[:19] }}</td>
                <td style="padding:0.75rem">
                  <a href="{{ url_for('view_job', jobid=job.id) }}" class="btn" style="padding:0.35rem 0.7rem;margin-right:0.5rem;font-size:0.85rem;background:#2563eb">üëÅÔ∏è Ver</a>
                  <a href="{{ url_for('download_job', jobid=job.id) }}" class="btn" style="padding:0.35rem 0.7rem;font-size:0.85rem;background:#059669">üíæ JSON</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p style="color:#64748b;text-align:center;padding:2rem">No hay ejecuciones registradas. ¬°Ejecuta tu primer script arriba!</p>
    {% endif %}
  </div>

  <script>
    function updateParamsPlaceholder() {
      const type = document.getElementById('sim_type').value;
      
      // Campos a mostrar/ocultar
      const pinField = document.getElementById('pin_field');
      const minlatField = document.getElementById('minlat_field');
      const maxlatField = document.getElementById('maxlat_field');
      const qField = document.getElementById('q_field');
      const accField = document.getElementById('acc_field');
      const labelN = document.getElementById('label_n');
      
      if (type === 'flood') {
        // Flood: mostrar n, pin, minlat, maxlat
        labelN.textContent = 'ü§ñ N√∫mero de Bots';
        pinField.style.display = 'block';
        minlatField.style.display = 'block';
        maxlatField.style.display = 'block';
        qField.style.display = 'none';
        accField.style.display = 'none';
        
        document.getElementById('param_n').placeholder = '50';
        document.getElementById('param_minlat').placeholder = '50';
        document.getElementById('param_maxlat').placeholder = '300';
        
      } else if (type === 'answers') {
        // Answers: mostrar n, pin, q, acc
        labelN.textContent = 'ü§ñ N√∫mero de Bots';
        pinField.style.display = 'block';
        minlatField.style.display = 'none';
        maxlatField.style.display = 'none';
        qField.style.display = 'block';
        accField.style.display = 'block';
        
        document.getElementById('param_n').placeholder = '50';
        document.getElementById('param_q').placeholder = '10';
        document.getElementById('param_acc').placeholder = '0.8';
        
      } else if (type === 'graphical') {
        // GUI: solo mostrar n (eventos)
        labelN.textContent = 'üñ•Ô∏è N√∫mero de Eventos';
        pinField.style.display = 'none';
        minlatField.style.display = 'none';
        maxlatField.style.display = 'none';
        qField.style.display = 'none';
        accField.style.display = 'none';
        
        document.getElementById('param_n').placeholder = '20';
      }
    }
    
    // Inicializar al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', updateParamsPlaceholder);
  </script>
{% endblock %}