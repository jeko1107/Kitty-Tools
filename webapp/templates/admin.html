{% extends 'base.html' %}
{% block content %}
  <h1>Panel de Administraci√≥n</h1>
  
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div style="padding:0.75rem;margin-bottom:1rem;border-radius:4px;background:{% if category=='success' %}#10b98144{% elif category=='danger' or category=='error' %}#ef444444{% else %}#f59e0b44{% endif %};border-left:4px solid {% if category=='success' %}#10b981{% elif category=='danger' or category=='error' %}#ef4444{% else %}#f59e0b{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="card" style="background:#0f1a24;border:1px solid #1e3a5f;margin-bottom:2rem">
    <h2 style="color:#60a5fa;margin-top:0">üöÄ Ejecutar Simulaci√≥n</h2>
    <form method="POST" action="{{ url_for('admin_simulate') }}" style="display:grid;gap:1rem">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      
      <div>
        <label style="display:block;margin-bottom:0.5rem;color:#e2e8f0">Tipo de Simulaci√≥n</label>
        <select name="sim_type" id="sim_type" style="width:100%;padding:0.75rem;border:1px solid #334155;border-radius:4px;background:#1e293b;color:#e2e8f0" onchange="updateParams()">
          <option value="flood">üåä Kahoot Flood</option>
          <option value="answers">üìù Answer Hack</option>
          <option value="gui">üñ•Ô∏è GUI Mode</option>
        </select>
      </div>

      <div id="pin_field_container">
        <label for="pin_input" style="display:block;margin-bottom:0.5rem;color:#e2e8f0">PIN del Juego</label>
        <input id="pin_input" type="text" name="pin" placeholder="Ej: 123456" style="width:100%;padding:0.75rem;border:1px solid #334155;border-radius:4px;background:#1e293b;color:#e2e8f0">
        <small style="color:#94a3b8;display:block;margin-top:0.25rem">Requerido para GUI y Flood; opcional en Answers si usas Quiz ID</small>
      </div>

      <!-- Par√°metros para Flood -->
      <div id="flood_params" style="display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(200px,1fr))">
        <div>
          <label style="display:block;margin-bottom:0.5rem;color:#e2e8f0">N√∫mero de Bots (n)</label>
          <input type="number" name="param_n" value="50" min="1" max="500" style="width:100%;padding:0.75rem;border:1px solid #334155;border-radius:4px;background:#1e293b;color:#e2e8f0">
        </div>
        <div>
          <label style="display:block;margin-bottom:0.5rem;color:#e2e8f0">Latencia M√≠nima (ms)</label>
          <input type="number" name="param_minlat" value="50" min="0" max="5000" style="width:100%;padding:0.75rem;border:1px solid #334155;border-radius:4px;background:#1e293b;color:#e2e8f0">
        </div>
        <div>
          <label style="display:block;margin-bottom:0.5rem;color:#e2e8f0">Latencia M√°xima (ms)</label>
          <input type="number" name="param_maxlat" value="300" min="0" max="5000" style="width:100%;padding:0.75rem;border:1px solid #334155;border-radius:4px;background:#1e293b;color:#e2e8f0">
        </div>
        <div>
          <label style="display:block;margin-bottom:0.5rem;color:#e2e8f0">Nombre de Bot</label>
          <input type="text" name="param_name" placeholder="Bot" style="width:100%;padding:0.75rem;border:1px solid #334155;border-radius:4px;background:#1e293b;color:#e2e8f0">
        </div>
      </div>

      <!-- Par√°metros para Answers -->
      <div id="answers_params" style="display:none;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem">
        <div>
          <label style="display:block;margin-bottom:0.5rem;color:#e2e8f0">Quiz ID (UUID)</label>
          <input type="text" name="param_quiz_id" placeholder="Ej: f9822c0e-f70b-4987-9f86-51b87e38f001" style="width:100%;padding:0.75rem;border:1px solid #334155;border-radius:4px;background:#1e293b;color:#e2e8f0">
          <small style="color:#94a3b8;display:block;margin-top:0.25rem">Opcional si usas PIN</small>
        </div>
      </div>

      <!-- Par√°metros para GUI -->
      <div id="gui_params" style="display:none">
        <label style="display:block;margin-bottom:0.5rem;color:#e2e8f0">Par√°metro E</label>
        <input type="number" name="param_e" value="1" min="0" max="10" style="width:100%;padding:0.75rem;border:1px solid #334155;border-radius:4px;background:#1e293b;color:#e2e8f0">
      </div>

      <button type="submit" class="btn" style="background:#10b981;padding:0.875rem;font-size:1rem">
        ‚ñ∂Ô∏è Ejecutar Simulaci√≥n
      </button>
    </form>
  </div>

  <div class="card" style="background:#0f1a24;border:1px solid #1e3a5f">
    <h2 style="color:#60a5fa;margin-top:0">üìã Historial de Jobs</h2>
    {% if jobs %}
      <div style="overflow-x:auto">
        <table style="width:100%;border-collapse:collapse">
          <thead>
            <tr style="background:#1e293b">
              <th style="padding:0.75rem;text-align:left;border-bottom:2px solid #334155">ID</th>
              <th style="padding:0.75rem;text-align:left;border-bottom:2px solid #334155">Tipo</th>
              <th style="padding:0.75rem;text-align:left;border-bottom:2px solid #334155">Estado</th>
              <th style="padding:0.75rem;text-align:left;border-bottom:2px solid #334155">Fecha</th>
              <th style="padding:0.75rem;text-align:center;border-bottom:2px solid #334155">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for job in jobs %}
              <tr style="border-bottom:1px solid #334155">
                <td style="padding:0.75rem;font-family:monospace;font-size:0.85rem">{{ job.id[:12] }}...</td>
                <td style="padding:0.75rem">
                  {% if job.type == 'flood' %}üåä Flood
                  {% elif job.type == 'answers' %}üìù Answers
                  {% elif job.type == 'gui' %}üñ•Ô∏è GUI
                  {% else %}{{ job.type }}{% endif %}
                </td>
                <td style="padding:0.75rem">
                  {% if job.status == 'running' %}
                    <span style="color:#fbbf24;animation:pulse 2s infinite">‚ö° Ejecutando</span>
                  {% elif job.status == 'completed' %}
                    <span style="color:#10b981">‚úÖ Completado</span>
                  {% elif job.status == 'failed' %}
                    <span style="color:#ef4444">‚ùå Fallido</span>
                  {% elif job.status == 'stopped' %}
                    <span style="color:#f59e0b">‚è∏Ô∏è Detenido</span>
                  {% else %}
                    <span style="color:#94a3b8">{{ job.status }}</span>
                  {% endif %}
                </td>
                <td style="padding:0.75rem;font-size:0.85rem;color:#94a3b8">{{ job.created_at[:19].replace('T',' ') }}</td>
                <td style="padding:0.75rem;text-align:center">
                  <a href="{{ url_for('view_job', jobid=job.id) }}" class="btn" style="padding:0.35rem 0.7rem;margin-right:0.5rem;font-size:0.85rem;background:#2563eb">üëÅÔ∏è Ver</a>
                  <a href="{{ url_for('download_job', jobid=job.id) }}" class="btn" style="padding:0.35rem 0.7rem;font-size:0.85rem;background:#059669">üíæ JSON</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p style="color:#64748b;text-align:center;padding:2rem">No hay jobs registrados a√∫n.</p>
    {% endif %}
  </div>

  <script>
    function updateParams() {
      const simType = document.getElementById('sim_type').value;
      document.getElementById('flood_params').style.display = simType === 'flood' ? 'grid' : 'none';
      document.getElementById('answers_params').style.display = simType === 'answers' ? 'grid' : 'none';
      document.getElementById('gui_params').style.display = simType === 'gui' ? 'block' : 'none';
      const pinInput = document.getElementById('pin_input');
      if (simType === 'gui' || simType === 'flood') {
        pinInput.setAttribute('required', 'required');
      } else {
        pinInput.removeAttribute('required');
      }
    }
    updateParams();
  </script>

  <style>
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
{% endblock %}