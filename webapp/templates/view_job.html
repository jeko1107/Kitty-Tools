{% extends 'base.html' %}
{% block content %}
  <div style="margin-bottom:1rem">
    <a href="{{ url_for('admin') }}" style="color:#60a5fa;text-decoration:none">← Volver al panel de admin</a>
  </div>

  <h1>Resultados de Simulación</h1>

  <div class="card" style="background:#0f1a24;border:1px solid #1e3a5f">
    <h2 style="color:#60a5fa;margin-top:0">📋 Información General</h2>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-top:1rem">
      <div style="background:#1e293b;padding:1rem;border-radius:4px">
        <div style="color:#64748b;font-size:0.85rem">ID</div>
        <div style="color:#e2e8f0;font-family:monospace;margin-top:0.25rem">{{ job.id }}</div>
      </div>
      <div style="background:#1e293b;padding:1rem;border-radius:4px">
        <div style="color:#64748b;font-size:0.85rem">Estado</div>
        <div id="job-status" style="font-family:monospace;margin-top:0.25rem">
          {% if job.status == 'running' %}
            <span style="color:#fbbf24">⚡ Ejecutando</span>
          {% elif job.status == 'completed' %}
            <span style="color:#10b981">✅ Completado</span>
          {% elif job.status == 'failed' %}
            <span style="color:#ef4444">❌ Fallido</span>
          {% elif job.status == 'stopped' %}
            <span style="color:#f59e0b">⏸️ Detenido</span>
          {% elif job.status == 'timeout' %}
            <span style="color:#f59e0b">⏱️ Timeout</span>
          {% elif job.status == 'error' %}
            <span style="color:#ef4444">❌ Error</span>
          {% else %}
            <span style="color:#94a3b8">{{ job.status }}</span>
          {% endif %}
        </div>
      </div>
      <div style="background:#1e293b;padding:1rem;border-radius:4px">
        <div style="color:#64748b;font-size:0.85rem">Tipo</div>
        <div style="color:#e2e8f0;font-family:monospace;margin-top:0.25rem">
          {% if job.type == 'flood' %}🌊 Flood
          {% elif job.type == 'answers' %}📝 Answers
          {% elif job.type == 'gui' %}🖥️ GUI
          {% else %}{{ job.type }}{% endif %}
        </div>
      </div>
      <div style="background:#1e293b;padding:1rem;border-radius:4px">
        <div style="color:#64748b;font-size:0.85rem">Usuario</div>
        <div style="color:#e2e8f0;font-family:monospace;margin-top:0.25rem">{{ job.user }}</div>
      </div>
    </div>

    {% if job.status == 'running' %}
    <div style="margin-top:1rem">
      <form method="POST" action="{{ url_for('stop_job', jobid=job.id) }}" style="display:inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <button type="submit" class="btn" style="background:#ef4444">⏹️ Detener Job</button>
      </form>
    </div>
    {% endif %}
  </div>

  <div class="card" style="background:#0f1a24;border:1px solid#1e3a5f;margin-top:1.5rem">
    <h2 style="color:#60a5fa;margin-top:0">📊 Salida de Ejecución</h2>
    <div id="output-container" style="background:#1e293b;padding:1.5rem;border-radius:8px;max-height:800px;overflow-y:auto;font-family:monospace;color:#e2e8f0;font-size:0.9rem;line-height:1.6"></div>
  </div>

  <script>
    const jobId = '{{ job.id }}';
    const jobStatus = '{{ job.status }}';
    let pollInterval = null;
    let currentOutput = {{ job.result.output | tojson if job.result and job.result.output else '""' }};

    function formatKahootOutput(text) {
      // Convertir el texto plano en HTML formateado
      let html = text;
      
      // Detectar y formatear cajas de preguntas
      html = html.replace(/╔═+╗\n║\s+(📋 PREGUNTA #\d+)\s+║\n╚═+╝/g, 
        '<div style="background:linear-gradient(135deg,#1e3a8a,#3b82f6);padding:1rem;border-radius:8px;margin:1.5rem 0 0.5rem 0;box-shadow:0 4px 6px rgba(0,0,0,0.3)"><strong style="color:#fef3c7;font-size:1.1rem">$1</strong></div>');
      
      // Formatear preguntas (❓)
      html = html.replace(/❓ (.+)/g, '<div style="background:#0f172a;padding:1rem;border-left:4px solid #60a5fa;margin:0.5rem 0;border-radius:4px;color:#e2e8f0;font-size:1rem"><strong>❓ $1</strong></div>');
      
      // Formatear cajas de opciones
      html = html.replace(/┌─+┐\n│\s+(.+?)\s+│\n├─+┤/g, '<div style="background:#1e293b;border:2px solid #475569;border-radius:8px;padding:0.5rem;margin:1rem 0"><div style="padding:0.5rem;background:#334155;border-radius:4px;color:#fbbf24;font-weight:bold;text-align:center">$1</div><div style="padding:0.5rem">');
      
      html = html.replace(/└─+┘/g, '</div></div>');
      
      // Formatear respuestas con símbolos de Kahoot
      html = html.replace(/│ (🔴 △)\s+(✅|)\s*(.+?)\s+│/g, function(match, symbol, check, text) {
        if (check === '✅') {
          return '<div style="background:rgba(34,197,94,0.2);border-left:4px solid #22c55e;padding:0.75rem;margin:0.25rem 0;border-radius:4px;display:flex;align-items:center"><span style="font-size:1.3rem;margin-right:0.75rem">' + symbol + '</span><span style="flex:1">' + text + '</span><span style="color:#22c55e;font-size:1.2rem;margin-left:0.5rem">✅</span></div>';
        } else {
          return '<div style="background:rgba(51,65,85,0.3);border-left:4px solid #475569;padding:0.75rem;margin:0.25rem 0;border-radius:4px;display:flex;align-items:center"><span style="font-size:1.3rem;margin-right:0.75rem">' + symbol + '</span><span style="flex:1">' + text + '</span></div>';
        }
      });
      
      html = html.replace(/│ (🔵 ◇)\s+(✅|)\s*(.+?)\s+│/g, function(match, symbol, check, text) {
        if (check === '✅') {
          return '<div style="background:rgba(34,197,94,0.2);border-left:4px solid #22c55e;padding:0.75rem;margin:0.25rem 0;border-radius:4px;display:flex;align-items:center"><span style="font-size:1.3rem;margin-right:0.75rem">' + symbol + '</span><span style="flex:1">' + text + '</span><span style="color:#22c55e;font-size:1.2rem;margin-left:0.5rem">✅</span></div>';
        } else {
          return '<div style="background:rgba(51,65,85,0.3);border-left:4px solid #475569;padding:0.75rem;margin:0.25rem 0;border-radius:4px;display:flex;align-items:center"><span style="font-size:1.3rem;margin-right:0.75rem">' + symbol + '</span><span style="flex:1">' + text + '</span></div>';
        }
      });
      
      html = html.replace(/│ (🟡 ○)\s+(✅|)\s*(.+?)\s+│/g, function(match, symbol, check, text) {
        if (check === '✅') {
          return '<div style="background:rgba(34,197,94,0.2);border-left:4px solid #22c55e;padding:0.75rem;margin:0.25rem 0;border-radius:4px;display:flex;align-items:center"><span style="font-size:1.3rem;margin-right:0.75rem">' + symbol + '</span><span style="flex:1">' + text + '</span><span style="color:#22c55e;font-size:1.2rem;margin-left:0.5rem">✅</span></div>';
        } else {
          return '<div style="background:rgba(51,65,85,0.3);border-left:4px solid #475569;padding:0.75rem;margin:0.25rem 0;border-radius:4px;display:flex;align-items:center"><span style="font-size:1.3rem;margin-right:0.75rem">' + symbol + '</span><span style="flex:1">' + text + '</span></div>';
        }
      });
      
      html = html.replace(/│ (🟢 □)\s+(✅|)\s*(.+?)\s+│/g, function(match, symbol, check, text) {
        if (check === '✅') {
          return '<div style="background:rgba(34,197,94,0.2);border-left:4px solid #22c55e;padding:0.75rem;margin:0.25rem 0;border-radius:4px;display:flex;align-items:center"><span style="font-size:1.3rem;margin-right:0.75rem">' + symbol + '</span><span style="flex:1">' + text + '</span><span style="color:#22c55e;font-size:1.2rem;margin-left:0.5rem">✅</span></div>';
        } else {
          return '<div style="background:rgba(51,65,85,0.3);border-left:4px solid #475569;padding:0.75rem;margin:0.25rem 0;border-radius:4px;display:flex;align-items:center"><span style="font-size:1.3rem;margin-right:0.75rem">' + symbol + '</span><span style="flex:1">' + text + '</span></div>';
        }
      });
      
      // Formatear respuesta correcta final
      html = html.replace(/✨ RESPUESTA CORRECTA: (.+)/g, '<div style="background:linear-gradient(135deg,#065f46,#059669);padding:1rem;border-radius:8px;margin:1rem 0;text-align:center;box-shadow:0 4px 6px rgba(0,0,0,0.3)"><strong style="color:#d1fae5;font-size:1.1rem">✨ RESPUESTA CORRECTA: $1</strong></div>');
      
      // Formatear encuestas
      html = html.replace(/│\s+(📊 ENCUESTA .+?)\s+│/g, '<div style="padding:0.5rem;background:#7c3aed;border-radius:4px;color:#fef3c7;font-weight:bold;text-align:center">$1</div><div style="padding:0.5rem">');
      
      // Formatear secciones principales
      html = html.replace(/═{60}/g, '<hr style="border:none;border-top:2px solid #475569;margin:1.5rem 0">');
      html = html.replace(/─{60}/g, '<hr style="border:none;border-top:1px solid #334155;margin:1rem 0">');
      
      // Formatear emojis y títulos importantes
      html = html.replace(/(📊 INFORMACIÓN DEL QUIZ|❓ PREGUNTAS Y RESPUESTAS|✅ RESPUESTAS OBTENIDAS EXITOSAMENTE)/g, '<h3 style="color:#60a5fa;text-align:center;margin:1.5rem 0">$1</h3>');
      
      // Formatear información del quiz
      html = html.replace(/(🎯 Título: )(.+)/g, '<div style="margin:0.5rem 0"><strong style="color:#fbbf24">$1</strong><span style="color:#e2e8f0">$2</span></div>');
      html = html.replace(/(📄 Descripción: )(.+)/g, '<div style="margin:0.5rem 0"><strong style="color:#fbbf24">$1</strong><span style="color:#cbd5e1">$2</span></div>');
      html = html.replace(/(👤 Creador: )(.+)/g, '<div style="margin:0.5rem 0"><strong style="color:#fbbf24">$1</strong><span style="color:#e2e8f0">$2</span></div>');
      html = html.replace(/(📋 Total de preguntas: )(\d+)/g, '<div style="background:#1e3a8a;padding:0.75rem;border-radius:6px;margin:1rem 0;text-align:center"><strong style="color:#fef3c7">$1<span style="font-size:1.5rem;color:#60a5fa">$2</span></strong></div>');
      
      // Convertir saltos de línea
      html = html.replace(/\n/g, '<br>');
      
      return html;
    }

    function updateOutput(text) {
      const outputEl = document.getElementById('output-container');
      if (text.includes('PREGUNTA #')) {
        // Si contiene preguntas de Kahoot, formatear
        outputEl.innerHTML = formatKahootOutput(text);
      } else {
        // Output normal sin formato especial
        outputEl.innerHTML = '<pre style="margin:0;white-space:pre-wrap;font-family:monospace">' + text + '</pre>';
      }
      outputEl.scrollTop = outputEl.scrollHeight;
    }

    // Mostrar output inicial
    updateOutput(currentOutput);

    function updateJobStatus() {
      fetch(`/admin/job_status/${jobId}`)
        .then(res => res.json())
        .then(data => {
          // Actualizar estado
          const statusEl = document.getElementById('job-status');
          let statusHtml = '';
          if (data.status === 'running') {
            statusHtml = '<span style="color:#fbbf24">⚡ Ejecutando</span>';
          } else if (data.status === 'completed') {
            statusHtml = '<span style="color:#10b981">✅ Completado</span>';
            if (pollInterval) {
              clearInterval(pollInterval);
              setTimeout(() => location.reload(), 2000);
            }
          } else if (data.status === 'failed') {
            statusHtml = '<span style="color:#ef4444">❌ Fallido</span>';
            if (pollInterval) clearInterval(pollInterval);
          } else if (data.status === 'stopped') {
            statusHtml = '<span style="color:#f59e0b">⏸️ Detenido</span>';
            if (pollInterval) clearInterval(pollInterval);
          } else if (data.status === 'timeout') {
            statusHtml = '<span style="color:#f59e0b">⏱️ Timeout</span>';
            if (pollInterval) clearInterval(pollInterval);
          } else if (data.status === 'error') {
            statusHtml = '<span style="color:#ef4444">❌ Error</span>';
            if (pollInterval) clearInterval(pollInterval);
          }
          statusEl.innerHTML = statusHtml;

          // Actualizar output
          if (data.new_lines && data.new_lines.length > 0) {
            data.new_lines.forEach(line => {
              currentOutput += line + '\n';
            });
            updateOutput(currentOutput);
          } else if (data.output) {
            currentOutput = data.output;
            updateOutput(currentOutput);
          }
        })
        .catch(err => console.error('Error polling job:', err));
    }

    // Iniciar polling si el job está corriendo
    if (jobStatus === 'running') {
      pollInterval = setInterval(updateJobStatus, 2000);
    }
  </script>

  {% if job.status in ['completed', 'failed', 'timeout'] and job.result %}
    <div class="card" style="background:#0f1a24;border:1px solid #1e3a5f;margin-top:1.5rem">
      <h2 style="color:#60a5fa;margin-top:0">📈 Métricas</h2>
      
      {% if job.type == 'flood' and job.result.n_bots %}
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-top:1rem">
          <div style="background:#1e293b;padding:1rem;border-radius:4px">
            <div style="color:#64748b;font-size:0.85rem">Bots Totales</div>
            <div style="color:#60a5fa;font-size:2rem;font-weight:bold;margin-top:0.25rem">{{ job.result.n_bots }}</div>
          </div>
          <div style="background:#1e293b;padding:1rem;border-radius:4px">
            <div style="color:#64748b;font-size:0.85rem">Conectados</div>
            <div style="color:#10b981;font-size:2rem;font-weight:bold;margin-top:0.25rem">{{ job.result.connected }}</div>
          </div>
          {% if job.result.latency %}
          <div style="background:#1e293b;padding:1rem;border-radius:4px">
            <div style="color:#64748b;font-size:0.85rem">Latencia Min</div>
            <div style="color:#e2e8f0;font-size:1.5rem;font-weight:bold;margin-top:0.25rem">{{ job.result.latency.min }}ms</div>
          </div>
          <div style="background:#1e293b;padding:1rem;border-radius:4px">
            <div style="color:#64748b;font-size:0.85rem">Latencia Max</div>
            <div style="color:#e2e8f0;font-size:1.5rem;font-weight:bold;margin-top:0.25rem">{{ job.result.latency.max }}ms</div>
          </div>
          <div style="background:#1e293b;padding:1rem;border-radius:4px">
            <div style="color:#64748b;font-size:0.85rem">Latencia Avg</div>
            <div style="color:#fbbf24;font-size:1.5rem;font-weight:bold;margin-top:0.25rem">{{ job.result.latency.avg }}ms</div>
          </div>
          {% endif %}
        </div>
      {% elif job.type == 'answers' and job.result.n_questions %}
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-top:1rem">
          <div style="background:#1e293b;padding:1rem;border-radius:4px">
            <div style="color:#64748b;font-size:0.85rem">Preguntas</div>
            <div style="color:#60a5fa;font-size:2rem;font-weight:bold;margin-top:0.25rem">{{ job.result.n_questions }}</div>
          </div>
          <div style="background:#1e293b;padding:1rem;border-radius:4px">
            <div style="color:#64748b;font-size:0.85rem">Precisión</div>
            <div style="color:#10b981;font-size:2rem;font-weight:bold;margin-top:0.25rem">{{ (job.result.accuracy * 100) | round(1) }}%</div>
          </div>
        </div>
      {% endif %}

      {% if job.result.exit_code is defined %}
        <div style="margin-top:1rem;padding:1rem;background:#1e293b;border-radius:4px">
          <div style="color:#64748b;font-size:0.85rem">Exit Code</div>
          <div style="color:{{ '#10b981' if job.result.exit_code == 0 else '#ef4444' }};font-family:monospace;margin-top:0.25rem">{{ job.result.exit_code }}</div>
        </div>
      {% endif %}
    </div>
  {% endif %}

  {% if job.params %}
    <div class="card" style="background:#0f1a24;border:1px solid #1e3a5f;margin-top:1.5rem">
      <h2 style="color:#60a5fa;margin-top:0">⚙️ Parámetros de Ejecución</h2>
      <div style="background:#1e293b;padding:1rem;border-radius:4px;font-family:monospace;font-size:0.9rem;color:#e2e8f0">
        <pre style="margin:0">{{ job.params | tojson(indent=2) }}</pre>
      </div>
    </div>
  {% endif %}

  <div class="card" style="background:#0f1a24;border:1px solid #1e3a5f;margin-top:1.5rem">
    <h2 style="color:#60a5fa;margin-top:0">🕐 Timestamps</h2>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;margin-top:1rem">
      <div style="background:#1e293b;padding:1rem;border-radius:4px">
        <div style="color:#64748b;font-size:0.85rem">Creado</div>
        <div style="color:#e2e8f0;font-family:monospace;margin-top:0.25rem">{{ job.created_at[:19].replace('T', ' ') }}</div>
      </div>
      {% if job.completed_at %}
      <div style="background:#1e293b;padding:1rem;border-radius:4px">
        <div style="color:#64748b;font-size:0.85rem">Completado</div>
        <div style="color:#e2e8f0;font-family:monospace;margin-top:0.25rem">{{ job.completed_at[:19].replace('T', ' ') }}</div>
      </div>
      {% endif %}
    </div>
  </div>

  <script>
{% endblock %}
