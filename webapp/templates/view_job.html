{% extends 'base.html' %}
{% block content %}
  <div style="margin-bottom:1rem">
    <a href="{{ url_for('admin') }}" style="color:#60a5fa;text-decoration:none">‚Üê Volver al panel de admin</a>
  </div>

  <h1>Resultados de Simulaci√≥n</h1>

  <div class="card" style="background:#0f1a24;border:1px solid #1e3a5f">
    <h2 style="color:#60a5fa;margin-top:0">üìã Informaci√≥n General</h2>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-top:1rem">
      <div style="background:#1e293b;padding:1rem;border-radius:4px">
        <div style="color:#64748b;font-size:0.85rem">ID</div>
        <div style="color:#e2e8f0;font-family:monospace;margin-top:0.25rem">{{ job.id }}</div>
      </div>
      <div style="background:#1e293b;padding:1rem;border-radius:4px">
        <div style="color:#64748b;font-size:0.85rem">Tipo</div>
        <div style="color:#e2e8f0;margin-top:0.25rem">
          {% if job.type == 'flood' %}üåä Kahoot Flood
          {% elif job.type == 'answers' %}üìù Answer Hack
          {% elif job.type == 'graphical' %}üñ•Ô∏è GUI
          {% else %}{{ job.type }}{% endif %}
        </div>
      </div>
      <div style="background:#1e293b;padding:1rem;border-radius:4px">
        <div style="color:#64748b;font-size:0.85rem">Estado</div>
        <div style="margin-top:0.25rem">
          <span style="padding:0.25rem 0.5rem;border-radius:3px;background:#1a2f1a;color:#86efac">
            {{ job.status }}
          </span>
        </div>
      </div>
      <div style="background:#1e293b;padding:1rem;border-radius:4px">
        <div style="color:#64748b;font-size:0.85rem">Usuario</div>
        <div style="color:#e2e8f0;margin-top:0.25rem">{{ job.user }}</div>
      </div>
      <div style="background:#1e293b;padding:1rem;border-radius:4px">
        <div style="color:#64748b;font-size:0.85rem">Fecha</div>
        <div style="color:#e2e8f0;margin-top:0.25rem">{{ job.created_at[:19] }}</div>
      </div>
    </div>
  </div>

  {% if job.result %}
    {% if job.type == 'flood' %}
      <div class="card" style="background:#0f1a24;border:1px solid #1e3a5f">
        <h2 style="color:#60a5fa;margin-top:0">üåä Resultados de Flood</h2>
        
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin:1rem 0">
          <div style="background:#1e293b;padding:1rem;border-radius:4px;text-align:center">
            <div style="color:#64748b;font-size:0.85rem">Total Bots</div>
            <div style="color:#60a5fa;font-size:2rem;font-weight:bold;margin-top:0.5rem">{{ job.result.n_bots }}</div>
          </div>
          {% set errors_color = '#fca5a5' if job.result.errors > 0 else '#86efac' %}
          <div style="background:#1e293b;padding:1rem;border-radius:4px;text-align:center">
            <div style="color:#64748b;font-size:0.85rem">Errores</div>
          <div class="errors-count" data-color="{{ errors_color }}">{{ job.result.errors }}</div>
          </div>
          <div style="background:#1e293b;padding:1rem;border-radius:4px;text-align:center">
            <div style="color:#64748b;font-size:0.85rem">Tiempo Total</div>
            <div style="color:#fcd34d;font-size:2rem;font-weight:bold;margin-top:0.5rem">{{ "%.3f"|format(job.result.elapsed_s) }}s</div>
          </div>
          <div style="background:#1e293b;padding:1rem;border-radius:4px;text-align:center">
            <div style="color:#64748b;font-size:0.85rem">Tasa de √âxito</div>
            <div style="color:#86efac;font-size:2rem;font-weight:bold;margin-top:0.5rem">{{ "%.1f"|format((job.result.n_bots - job.result.errors) * 100.0 / job.result.n_bots) }}%</div>
          </div>
        </div>

        <h3 style="color:#94a3b8;margin-top:2rem">Lista de Bots</h3>
        <div style="max-height:400px;overflow-y:auto;background:#1e293b;padding:1rem;border-radius:4px">
          <table style="width:100%;border-collapse:collapse;color:#e2e8f0;font-size:0.9rem">
            <thead>
              <tr style="border-bottom:2px solid #334155;position:sticky;top:0;background:#1e293b">
                <th style="padding:0.5rem;text-align:left">Bot</th>
                <th style="padding:0.5rem;text-align:right">Delay (s)</th>
                <th style="padding:0.5rem;text-align:right">Respuesta (s)</th>
                <th style="padding:0.5rem;text-align:center">Estado</th>
              </tr>
            </thead>
            <tbody>
              {% for bot in job.result.bots %}
                <tr style="border-bottom:1px solid #334155">
                  <td style="padding:0.5rem;font-family:monospace">{{ bot.name }}</td>
                  <td style="padding:0.5rem;text-align:right">{{ "%.3f"|format(bot.join_delay_s) }}</td>
                  <td style="padding:0.5rem;text-align:right">{{ "%.3f"|format(bot.response_time_s) }}</td>
                  <td style="padding:0.5rem;text-align:center">
                    {% if bot.status == 'ok' %}
                      <span style="color:#86efac">‚úì</span>
                    {% else %}
                      <span style="color:#fca5a5">‚úó</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    {% elif job.type == 'answers' %}
      <div class="card" style="background:#0f1a24;border:1px solid #1e3a5f">
        <h2 style="color:#60a5fa;margin-top:0">üìù Resultados de Answer Hack</h2>
        
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin:1rem 0">
          <div style="background:#1e293b;padding:1rem;border-radius:4px;text-align:center">
            <div style="color:#64748b;font-size:0.85rem">Total Bots</div>
            <div style="color:#60a5fa;font-size:2rem;font-weight:bold;margin-top:0.5rem">{{ job.result.n_bots }}</div>
          </div>
          <div style="background:#1e293b;padding:1rem;border-radius:4px;text-align:center">
            <div style="color:#64748b;font-size:0.85rem">Preguntas</div>
            <div style="color:#fcd34d;font-size:2rem;font-weight:bold;margin-top:0.5rem">{{ job.result.n_questions }}</div>
          </div>
          <div style="background:#1e293b;padding:1rem;border-radius:4px;text-align:center">
            <div style="color:#64748b;font-size:0.85rem">Precisi√≥n Config</div>
            <div style="color:#86efac;font-size:2rem;font-weight:bold;margin-top:0.5rem">{{ "%.0f"|format(job.result.accuracy * 100) }}%</div>
          </div>
          <div style="background:#1e293b;padding:1rem;border-radius:4px;text-align:center">
            <div style="color:#64748b;font-size:0.85rem">Score Promedio</div>
            <div style="color:#a78bfa;font-size:2rem;font-weight:bold;margin-top:0.5rem">{{ job.result.avg_score }}/{{ job.result.n_questions }}</div>
          </div>
        </div>

        <h3 style="color:#94a3b8;margin-top:2rem">Rendimiento por Bot</h3>
        <div style="max-height:400px;overflow-y:auto;background:#1e293b;padding:1rem;border-radius:4px">
          <table style="width:100%;border-collapse:collapse;color:#e2e8f0;font-size:0.9rem">
            <thead>
              <tr style="border-bottom:2px solid #334155;position:sticky;top:0;background:#1e293b">
                <th style="padding:0.5rem;text-align:left">Bot</th>
                <th style="padding:0.5rem;text-align:center">Correctas</th>
                <th style="padding:0.5rem;text-align:center">Score</th>
                <th style="padding:0.5rem;text-align:center">Progreso</th>
              </tr>
            </thead>
            <tbody>
              {% for bot in job.result.bots %}
                <tr style="border-bottom:1px solid #334155">
                  <td style="padding:0.5rem;font-family:monospace">{{ bot.name }}</td>
                  <td style="padding:0.5rem;text-align:center">{{ bot.correct }}</td>
                  <td style="padding:0.5rem;text-align:center;color:#a78bfa;font-weight:bold">{{ "%.0f"|format(bot.correct * 100.0 / job.result.n_questions) }}%</td>
                  {% set pct = 0 %}
                  {% if job.result.n_questions and job.result.n_questions != 0 %}
                    {% set pct = ((bot.correct * 100.0) / job.result.n_questions)|int %}
                  {% endif %}
                  <td style="padding:0.5rem">
                    <div style="background:#334155;height:8px;border-radius:4px;overflow:hidden">
                        <div class="bot-progress" data-pct="{{ pct }}"></div>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    {% elif job.type == 'graphical' %}
      <div class="card" style="background:#0f1a24;border:1px solid #1e3a5f">
        <h2 style="color:#60a5fa;margin-top:0">üñ•Ô∏è Resultados de GUI</h2>
        
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin:1rem 0">
          <div style="background:#1e293b;padding:1rem;border-radius:4px;text-align:center">
            <div style="color:#64748b;font-size:0.85rem">Total Eventos</div>
            <div style="color:#60a5fa;font-size:2rem;font-weight:bold;margin-top:0.5rem">{{ job.result.events }}</div>
          </div>
          <div style="background:#1e293b;padding:1rem;border-radius:4px;text-align:center">
            <div style="color:#64748b;font-size:0.85rem">Tiempo Total</div>
            <div style="color:#fcd34d;font-size:2rem;font-weight:bold;margin-top:0.5rem">{{ "%.3f"|format(job.result.elapsed_s) }}s</div>
          </div>
        </div>

        <h3 style="color:#94a3b8;margin-top:2rem">Log de Eventos</h3>
        <div style="max-height:400px;overflow-y:auto;background:#1e293b;padding:1rem;border-radius:4px;font-family:monospace;font-size:0.85rem">
          {% if job.result.log %}
            <p>Log: <a href="{{ url_for('download_log', jobid=job.id) }}">Descargar</a></p>
            <pre>{{ job.result.output }}</pre>
          {% else %}
            <pre>{{ job.result.output }}</pre>
          {% endif %}
        </div>
      </div>
    {% endif %}
  {% endif %}

  <!-- Secci√≥n de salida en tiempo real -->
  <div class="card" style="background:#0f1a24;border:1px solid #1e3a5f">
    <h3 style="color:#60a5fa;margin-top:0">üìÑ Salida en Tiempo Real</h3>
    <div id="job-status-badge" style="display:inline-block;padding:0.25rem 0.75rem;border-radius:3px;background:#1a2f1a;color:#86efac;font-size:0.9rem;margin-bottom:1rem">
      Estado: <span id="status-text">{{ job.status }}</span>
    </div>
    <div id="live-output" style="max-height:500px;overflow-y:auto;background:#1e293b;padding:1rem;border-radius:4px;font-family:monospace;font-size:0.85rem;white-space:pre-wrap;color:#e2e8f0">
      {{ job.result.output or 'Iniciando ejecuci√≥n...' }}
    </div>
    {% if job.result.log %}
      <p style="margin-top:1rem"><a href="{{ url_for('download_log', jobid=job.id) }}" style="color:#60a5fa">üíæ Descargar log completo</a></p>
    {% endif %}
  </div>

  <div class="card" style="background:#0f1a24;border:1px solid #1e3a5f">
    <h3 style="color:#60a5fa;margin-top:0">üîß Acciones</h3>
    <a href="{{ url_for('download_job', jobid=job.id) }}" class="btn" style="background:#059669;margin-right:1rem">üíæ Descargar JSON</a>
    <a href="{{ url_for('admin') }}" class="btn" style="background:#2563eb">‚Üê Volver al Panel</a>
  </div>
  <script>
    // Aplicar estilos din√°micos basados en data-attributes
    document.addEventListener('DOMContentLoaded', function(){
      document.querySelectorAll('.errors-count').forEach(function(el){
        var c = el.getAttribute('data-color') || '#86efac';
        el.style.color = c;
        el.style.fontSize = '2rem';
        el.style.fontWeight = 'bold';
        el.style.marginTop = '0.5rem';
      });
      document.querySelectorAll('.bot-progress').forEach(function(el){
        var pct = parseInt(el.getAttribute('data-pct') || '0', 10);
        el.style.background = '#86efac';
        el.style.height = '100%';
        el.style.width = pct + '%';
      });

      // Polling para actualizar salida en tiempo real
      var jobId = '{{ job.id }}';
      var currentStatus = '{{ job.status }}';
      var pollInterval = null;

      function updateJobStatus() {
        fetch('/admin/job_status/' + jobId)
          .then(function(response) {
            if (!response.ok) throw new Error('Error al obtener estado del job');
            return response.json();
          })
          .then(function(data) {
            // Actualizar estado
            var statusEl = document.getElementById('status-text');
            var badgeEl = document.getElementById('job-status-badge');
            var outputEl = document.getElementById('live-output');

            if (statusEl) statusEl.textContent = data.status;
            
            // Actualizar color del badge seg√∫n estado
            if (badgeEl) {
              if (data.status === 'success') {
                badgeEl.style.background = '#1a2f1a';
                badgeEl.style.color = '#86efac';
              } else if (data.status === 'error') {
                badgeEl.style.background = '#2f1a1a';
                badgeEl.style.color = '#fca5a5';
              } else if (data.status === 'running') {
                badgeEl.style.background = '#1a2a2f';
                badgeEl.style.color = '#60a5fa';
              }
            }

            // Actualizar salida
            if (outputEl && data.output) {
              outputEl.textContent = data.output;
              // Auto-scroll al final
              outputEl.scrollTop = outputEl.scrollHeight;
            }

            // Detener polling si el job termin√≥
            if (data.status === 'success' || data.status === 'error') {
              if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
                console.log('Job finalizado, polling detenido');
              }
            }

            currentStatus = data.status;
          })
          .catch(function(err) {
            console.error('Error en polling:', err);
          });
      }

      // Iniciar polling solo si el job est√° running
      if (currentStatus === 'running') {
        // Primera actualizaci√≥n inmediata
        updateJobStatus();
        // Luego cada 2 segundos
        pollInterval = setInterval(updateJobStatus, 2000);
      }
    });
  </script>
{% endblock %}
